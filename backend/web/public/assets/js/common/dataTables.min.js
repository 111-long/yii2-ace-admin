var oLoading=null;function alwaysClose(){layer.close(oLoading)}function ajaxFail(){return layer.msg("服务器繁忙,请稍候再试...",{time:1000,icon:2})}function empty(val){return val==undefined||val==""}function in_array(val,arr){for(var i in arr){if(arr[i]===val){return true}}return false}function ucfirst(str){return str.substr(0,1).toUpperCase()+str.substr(1)}function handleParams(params,prefix){var other="";prefix=prefix?prefix:'';if(params!=undefined&&typeof params=="object"){for(var i in params){other+=" "+i+'="'+prefix+params[i]+'" '}}return other}function Label(content,params){return"<label "+handleParams(params)+"> "+content+" </label>"}function createInput(params,type){return'<input type="'+type+'" '+handleParams(params)+" />"}function createPassword(params){return createInput(params,'password')}function createText(params){return createInput(params,'text')}function createTextarea(params){if(empty(params)){params={"class":" form-control","rows":5}}return"<textarea "+handleParams(params)+"></textarea>"}function createDiv(params){return"<div "+handleParams(params)+"></div>"}function createRadio(params,data,checked){var html="";params=handleParams(params);if(data!=undefined&&typeof data=="object"){for(var i in data){var check=checked==i?' checked="checked" ':"";html+='<label class="line-height-1 blue"> <input type="radio" '+params+check+' value="'+i+'"  /> <span class="lbl"> '+data[i]+" </span> </label>　 "}}return html}function createSelect(params,data,selected){var html="";params=handleParams(params);if(data!=undefined&&typeof data=="object"){html+="<select "+params+">";for(var i in data){var select=i==selected?' selected="selected" ':"";html+='<option value="'+i+'" '+select+" >"+data[i]+"</option>"}html+="</select>"}return html}function createFile(params){var html='';if(params.options&&params.options.type){html='<input type="file" '+handleParams(params)+'/>'}else{html='<input type="hidden" name="'+params.name+'"/>';params["input-name"]=params.name;params.name=empty(params["file-name"])?'UploadForm['+params.name+']':params["file-name"];html+='<input type="file" '+handleParams(params)+'/>'}return html}function createDate(params){return'<div class="input-group bootstrap-datepicker">         <input class="form-control date-picker me-date"  type="text" '+handleParams(params)+'/>         <span class="input-group-addon"><i class="fa fa-calendar bigger-110"></i></span>         </div>'}function createTime(params){return'<div class="input-group bootstrap-timepicker">         <input type="text" class="form-control time-picker" '+handleParams(params)+'/>         <span class="input-group-addon"><i class="fa fa-clock-o bigger-110"></i></span>         </div>'}function createDatetime(params){return'<div class="input-group bootstrap-datetimepicker">         <input type="text" class="form-control datetime-picker" '+handleParams(params)+'/>         <span class="input-group-addon"><i class="fa fa-clock-o bigger-110"></i></span>         </div>'}function createTimerange(params){return'<div class="input-daterange input-group">         <input type="text" class="input-sm form-control" name="start" />         <span class="input-group-addon"><i class="fa fa-exchange"></i></span>         <input type="text" class="input-sm form-control" name="end" />         </div>'}function createDaterange(params){return'<div class="input-group">         <span class="input-group-addon"><i class="fa fa-calendar bigger-110"></i></span>         <input class="form-control daterange-picker me-daterange" type="text" '+handleParams(params)+' />         </div>'}function createCheckbox(params,data,checked,arr,isHave){if(arr==undefined)arr='col-xs-6';var html='';params=handleParams(params);console.info(params);if(data!=undefined&&typeof data=="object"){if(isHave==undefined){html+='<div class="checkbox col-xs-12"><label><input type="checkbox" class="ace checkbox-all" onclick="var isChecked = $(this).prop(\'checked\');$(this).parent().parent().parent().find(\'input[type=checkbox]\').prop(\'checked\', isChecked);"  /><span class="lbl"> 选择全部 </span></label></div>'}for(var i in data){html+='<div class="checkbox '+arr+'"><label><input type="checkbox" '+params+' value="'+i+'" /><span class="lbl"> '+data[i]+' </span></label></div>'}}return html}function createButtons(index,data){var div1='<div class="hidden-sm hidden-xs btn-group">',div2='<div class="hidden-md hidden-lg"><div class="inline position-relative"><button data-position="auto" data-toggle="dropdown" class="btn btn-minier btn-primary dropdown-toggle"><i class="ace-icon fa fa-cog icon-only bigger-110"></i></button><ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">';if(data!=undefined&&typeof data=="object"){for(var i in data){div1+=' <button class="btn '+data[i]['className']+' '+data[i]['cClass']+' btn-xs" table-data="'+index+'"><i class="ace-icon fa '+data[i]["icon"]+' bigger-120"></i> '+(data[i]["button-title"]?data[i]["button-title"]:'')+'</button> ';div2+='<li><a title="'+data[i]['title']+'" data-rel="tooltip" class="tooltip-info '+data[i]['cClass']+'" href="javascript:;" data-original-title="'+data[i]['title']+'" table-data="'+index+'"><span class="'+data[i]['sClass']+'"><i class="ace-icon fa '+data[i]['icon']+' bigger-120"></i></span></a></li>'}}return div1+'</div>'+div2+'</ul></div></div>'}function createViewTr(title,data){return'<tr><td width="25%">'+title+'</td><td class="views-info data-info-'+data+'"></td></tr>'}function createSearchForm(k,v){k.search.options=$.extend({"name":k.sName,"vid":v,"class":"me-search"},k.search.options);if(k.search.type=="select"){k.value["All"]="全部"}var html=window['create'+ucfirst(k.search.type)](k.search.options,k.value,"All");if(k.search.type=="select")delete k.value["All"];return Label(k.title+" : "+html)+' '}function createModal(oModal,oViews){return'<div class="isHide" '+handleParams(oViews['params'])+'> '+oViews['html']+' </table></div>             <div class="modal fade '+(oModal["modalClass"]?oModal["modalClass"]:"")+'" '+handleParams(oModal['params'])+' tabindex="-1" role="dialog" >                 <div class="modal-dialog '+(oModal["modalDialogClass"]?oModal["modalDialogClass"]:"")+'" role="document">                     <div class="modal-content">                         <div class="modal-header">                             <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>                             <h4 class="modal-title"> 编 辑 </h4>                         </div>                         <div class="modal-body">'+oModal['html']+'</fieldset></form></div>                         <div class="modal-footer">                             <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>                             <button type="button" class="btn btn-primary btn-image '+oModal['bClass']+'">确定</button>                         </div>                     </div>                 </div>             </div>'}function validateFile(info){var error=[];if(info&&typeof info=="object"){if(info.error_count['ext']||info.error_count['mime'])error.push("上传文件类型错误");if(info.error_count['size'])error.push("上传文件过大")}return error.join(";")}function viewTable(object,data,tClass,row){object.forEach(function(k){var tmpKey=k.data,tmpValue=data[tmpKey],dataInfo=$(tClass+tmpKey);if(k.edit!=undefined&&k.edit.type=='password')tmpValue="******";(k.createdCell!=undefined&&typeof k.createdCell=="function")?k.createdCell(dataInfo,tmpValue,data,row,undefined):dataInfo.html(tmpValue)})}function handleMenuActive(strUrl){$('ul.nav-list a[href='+strUrl+']').closest('li').addClass('active').parentsUntil('ul.nav-list').addClass('active open')}function statusToString(td,data){$(td).html('<span class="label label-'+(data==1?'success">启用':'warning">禁用')+'</span>')}function dateTimeString(td,cellData){$(td).html(timeFormat(cellData,'yyyy-MM-dd hh:mm:ss'))}function adminToString(td,data,rowArr,row,col){$(td).html(aAdmins[data])}function showSpan(aData,aColorData,iVal,sDefaultClass){if(sDefaultClass==undefined)sDefaultClass='label label-sm ';return'<span class="'+sDefaultClass+' '+(aColorData[iVal]?aColorData[iVal]:'')+'"> '+(aData[iVal]?aData[iVal]:iVal)+' </span>'}Date.prototype.Format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)))}}return fmt};function timeFormat(time,str){if(empty(str)){str="yyyy-MM-dd"}var date=new Date(time*1000);return date.Format(str)}function InitForm(select,data){objForm=$(select).get(0);if(objForm!=undefined){$(objForm).find('input[type=hidden]').val('');$(objForm).find('input[type=checkbox]').each(function(){$(this).attr('checked',false);if($(this).get(0))$(this).get(0).checked=false});objForm.reset();if(data!=undefined){for(var i in data){if(typeof data[i]=='object'){for(var x in data[i]){var key=i+'['+x+']';if(objForm[key]!=undefined){objForm[key].value=data[i][x]}else{if(parseInt(data[i][x])>0){$('input[type=checkbox][name='+i+'\\[\\]][value='+data[i][x]+']').attr('checked',true).each(function(){this.checked=true})}}}}if(objForm[i]!=undefined&&objForm[i].type!="password"){var obj=$(objForm[i]),tmp=data[i];if(obj.hasClass('time-format')){tmp=timeFormat(parseInt(tmp),obj.attr('time-format')?obj.attr('time-format'):"yyyy-MM-dd hh:mm:ss")}objForm[i].value=tmp}}}}}function aceFileInputAjax(file_input,url){var $form=file_input.closest('form'),files=file_input.data('ace_input_files'),deferred=new $.Deferred;if(!files||files.length==0){deferred.resolve();return deferred.promise()}if("FormData"in window){formData_object=new FormData();$.each($form.serializeArray(),function(i,item){formData_object.append(item.name,item.value)});formData_object.append(file_input.attr('name'),files[0]);file_input.ace_file_input('loading',true);deferred=$.ajax({url:url,type:'Post',processData:false,contentType:false,dataType:'json',data:formData_object,})}else{var temporary_iframe_id='temporary-iframe-'+(new Date()).getTime()+'-'+(parseInt(Math.random()*1000));var temp_iframe=$('<iframe id="'+temporary_iframe_id+'" name="'+temporary_iframe_id+'" 								frameborder="0" width="0" height="0" src="about:blank"								style="position:absolute; z-index:-1; visibility: hidden;"></iframe>').insertAfter($form);$form.append('<input type="hidden" name="temporary-iframe-id" value="'+temporary_iframe_id+'" />');temp_iframe.data('deferrer',deferred);$form.attr({method:'POST',enctype:'multipart/form-data',target:temporary_iframe_id});file_input.ace_file_input('loading',true);$form.get(0).submit();ie_timeout=setTimeout(function(){ie_timeout=null;temp_iframe.attr('src','about:blank').remove();deferred.reject({'status':'fail','message':'Timeout!'})},30000)}return deferred}function aceFileUpload(select,sFileUploadUrl){var $input=$(select),$file=$('input[type=hidden][name='+$input.attr('input-name')+']'),allowExt=$input.attr('allowExt')?$input.attr('allowExt').split(','):null,allowMime=$input.attr('allowMime')?$input.attr('allowMime').split(','):null,maxSize=parseInt($input.attr('maxSize')),denyExt=$input.attr('denyExt')?$input.attr('denyExt').split(','):null,ie_timeout=null,aParams={allowExt:allowExt?allowExt:['jpg','jpeg','png','gif'],maxSize:maxSize?maxSize:200000000,denyExt:denyExt?denyExt:['exe','php']};if(allowMime)aParams["allowMime"]=allowMime;var oOther={};if($input.attr('input-type')=='ace_file'){oOther={no_file:'没有选择文件 ...',btn_choose:'选择',btn_change:'更换文件',droppable:false,thumbnail:false}}else{oOther={style:'well',btn_choose:'单击此处删除文件或单击“选择”',btn_change:null,no_icon:'ace-icon fa fa-cloud-upload',droppable:true,thumbnail:'small'}}aParams=$.extend(aParams,oOther);aParams["before_remove"]=function(){if($file.val()){$.post(sFileUploadUrl,{"face":$file.val()})}$file.val('');return true};$input.ace_file_input(aParams).on('change',function(){var deferred=aceFileInputAjax($input,sFileUploadUrl+'?sField='+$input.attr('input-name'));deferred.done(function(json){if(json.errCode==0){layer.msg("上传文件的地址为："+json.data.sFilePath,{icon:6});$file.val(json.data.sFilePath)}else{layer.msg("上传文件出现错误Error:"+json.errMsg,{icon:5});$input.ace_file_input('apply_settings').ace_file_input('reset_input')}}).fail(function(){ajaxFail()}).always(function(){if(ie_timeout)clearTimeout(ie_timeout);ie_timeout=null;$input.ace_file_input('loading',false)});deferred.promise()}).on('file.error.ace',function(event,info){layer.msg('文件上传出现错误：'+validateFile(info),{icon:5});event.preventDefault()})}function createForm(k,oParams){var form='';if(!oParams.index)oParams.index=0;if(k.edit.options==undefined)k.edit.options={};if(!k.edit.type)k.edit.type="text";k.edit.options["name"]=k.sName;k.edit.options["class"]="form-control "+(k.edit.options["class"]?k.edit.options["class"]:"");if(k.edit.type==undefined)k.edit.type="text";if(k.edit.type=="hidden"){form+=createInput(k.edit.options,'hidden')}else{if(oParams.iMultiCols>1&&!oParams.aCols){oParams.aCols=[];var iLength=Math.ceil(12/oParams.iMultiCols);oParams.aCols[0]=Math.floor(iLength*0.3);oParams.aCols[1]=iLength-oParams.aCols[0]}if(!oParams.bMultiCols||(oParams.iColsLength>1&&oParams.index%oParams.iColsLength==0)){form+='<div class="form-group">'}form+=Label(k.title,{"class":"col-sm-"+oParams.aCols[0]+" control-label"});form+='<div class="col-sm-'+oParams.aCols[1]+'">';if(k.edit.type=="radio")k.edit.options['class']='ace valid';if(k.edit.type=="checkbox"){k.edit.options['class']='ace m-checkbox';k.edit.options['name']=k.sName+'[]'}if(k.edit.type=="text")if(!empty(k.value))k.edit.options["value"]=k.value;form+=window['create'+ucfirst(k.edit.type)](k.edit.options,k.value,k.edit.default);form+='</div>';if(!oParams.bMultiCols||(oParams.iColsLength>1&&oParams.index%oParams.iColsLength==(oParams.iColsLength-1))){form+='</div>'}oParams.index++}return form}var MeTable=(function(){function MeTable(options,tableOptions,detailOptions){this.tableOptions={"bLengthChange":true,"bAutoWidth":false,"bPaginate":true,"iDisplayStart":0,"iDisplayLength":10,"bServerSide":true,"bRetrieve":true,"bDestroy":true,"sPaginationType":"full_numbers","order":[[1,"desc"]]};var self=this;this.options={sModal:"#myModal",sTitle:"",sTable:"#showTable",sFormId:"#editForm",sMethod:"POST",sBaseUrl:"",aActionUrl:{"search":"search","insert":"create","update":"update","delete":"delete","deleteAll":"delete-all","export":"export","upload":"upload"},isCheckbox:true,oOperation:{isOpen:true,width:"120px",title:"操作",buttons:[{"title":"查看","className":"btn-success","cClass":"me-table-view","icon":"fa-search-plus","sClass":"blue"},{"title":"编辑","className":"btn-info","cClass":"me-table-edit","icon":"fa-pencil-square-o","sClass":"green"},{"title":"删除","className":"btn-danger","cClass":"me-table-del","icon":"fa-trash-o","sClass":"red"}]},aParams:null,sExportUrl:"export",sSearchHtml:"",sSearchType:"middle",sSearchForm:"#searchForm",aFileSelector:[],oEditFormParams:{bMultiCols:false,iColsLength:1,aCols:[3,9],sModalClass:"",sModalDialogClass:""},oViewLayerConfig:{type:1,shade:0.3,shadeClose:true,maxmin:true,area:['50%','auto']},bRenderH1:true,bEditTable:false,oEditTable:{},sEditUrl:"editable",sEditPk:"id",iViewLoading:0,iLoading:0,bViewFull:false,bColResize:false,oLanguage:{dataTables:{"sLengthMenu":"每页 _MENU_ 条记录","sZeroRecords":"没有找到记录","sInfo":"显示 _START_ 到 _END_ 共有 _TOTAL_ 条数据","sInfoEmpty":"无记录","sInfoFiltered":"(从 _MAX_ 条记录过滤)","sSearch":"搜索：","oPaginate":{"sFirst":"首页","sPrevious":"上一页","sNext":"下一页","sLast":"尾页"}}}};this.tableOptions.fnServerData=function(sSource,aoData,fnCallback){self.options.iLoading=layer.load();var attributes=aoData[2].value.split(","),mSort=(attributes.length+1)*5+2;var data=$(self.options.sSearchForm).serializeArray();for(var i in data){if(empty(data[i]["value"])||data[i]["value"]=="All")continue;aoData.push({"name":"params["+data[i]['name']+"]","value":data[i]["value"]})}if(aoData[mSort].value!=undefined&&aoData[mSort].value!="")aoData.push({"name":'params[orderBy]',"value":attributes[parseInt(aoData[mSort].value)]});$.ajax({url:sSource,data:aoData,type:self.options.sMethod,dataType:'json'}).always(function(){layer.close(self.options.iLoading)}).done(function(data){if(data.errCode!=0)return layer.msg('出现错误:'+data.errMsg,{time:2000,icon:5});$.fn.dataTable.defaults['bFilter']=true;fnCallback(data.data)}).fail(ajaxFail)};options.oEditFormParams=$.extend(this.options.oEditFormParams,options.oEditFormParams);options.aActionUrl=$.extend(this.options.aActionUrl,options.aActionUrl);options.oOperation=$.extend(this.options.oOperation,options.oOperation);this.tableOptions=$.extend(this.tableOptions,tableOptions);this.options=$.extend(this.options,options);this.formOptions=$.extend({"method":"post","id":"editForm","class":"form-horizontal","name":"editForm","action":"update"},this.options.formOptions);if(empty(this.tableOptions.sAjaxSource)){this.tableOptions.sAjaxSource=this.options.sBaseUrl+this.options.aActionUrl.search}if(this.options.isCheckbox){this.tableOptions.aoColumns.unshift({"data":null,"bSortable":false,"class":"center","title":'<label class="position-relative"><input type="checkbox" class="ace" /><span class="lbl"></span></label>',"bViews":false,"render":function(data){return'<label class="position-relative"><input type="checkbox" value="'+data["id"]+'" class="ace" /><span class="lbl"></span></label>'}})}this.tableOptions.oLanguage=this.options.oLanguage.dataTables;if(this.options.oOperation.isOpen){this.tableOptions.aoColumns.push({"data":null,"bSortable":false,"title":this.options.oOperation.title,"width":this.options.oOperation.width,"createdCell":function(td,data,rowArr,row,col){$(td).html(createButtons(row,self.options.oOperation.buttons))}})}this.actionType="";this.bHandleDetails=false;this.oDetails=null;this.bDetail=false;if(detailOptions!=undefined&&typeof detailOptions=="object"){this.bHandleDetails=true;this.oDetailParams=null;this.oDetailObject=null;this.oDetails={sTable:"#detailTable",sModal:"#myDetailModal",sFormId:"#myDetailForm",sBaseUrl:self.options.sBaseUrl,sActionUrl:{"insert":"create","update":"update","delete":"delete"},sClickSelect:"td.details-control",oTableOptions:{"bPaginate":false,"bLengthChange":false,"bServerSide":true,"bAutoWidth":false,"sAjaxSource":"view","fnServerData":function(sSource,aoData,fnCallback){if(self.oDetailParams){self.options.iLoading=layer.load()for(var i in self.oDetailParams)aoData.push({name:i,value:self.oDetailParams[i]})$.ajax({url:sSource,data:aoData,type:'post',dataType:'json'}).always(function(){layer.close(self.options.iLoading)}).done(function(data){if(data.errCode!=0)return layer.msg('出现错误:'+data.errMsg,{time:2000,icon:5});$.fn.dataTable.defaults['bFilter']=true;fnCallback(data.data);if(self.oDetailObject)self.oDetailObject.child(function(){return $('#detailTable').parent().html()}).show()}).fail(ajaxFail)}},"searching":false,"ordering":false,"oLanguage":self.options.oLanguage.dataTables}};detailOptions.oTableOptions=$.extend(this.oDetails.oTableOptions,detailOptions.oTableOptions)this.oDetails=$.extend(this.oDetails,detailOptions)}}MeTable.prototype.CreateForm=function(){var self=this,formParams=handleParams(this.formOptions),form='<form '+formParams+'><fieldset>',views='<table class="table table-bordered table-striped table-detail">',aOrders=[],aTargets=[];this.tableOptions.aoColumns.forEach(function(k,v){if(k.bViews!==false)views+=createViewTr(k.title,k.data);if(k.edit!=undefined)form+=createForm(k,self.options.oEditFormParams);if(k.search!=undefined)self.options.sSearchHtml+=createSearchForm(k,v);if(k.defaultOrder)aOrders.push([v,k.defaultOrder]);if(k.isHide)aTargets.push(v);if(k.editTable!=undefined){self.options.oEditTable[k.sName]={name:k.sName,type:k.edit.type=="radio"?"select":k.edit.type,source:k.value,send:"always",url:self.options.sEditUrl,title:k.title,success:function(response){if(response.errCode!=0)return response.errMsg},error:function(){$.gritter.add({title:'温馨提醒',text:'服务器没有响应',class_name:'gritter-warning gritter-center',time:800,})}};self.options.oEditTable[k.sName]=$.extend(self.options.oEditTable[k.sName],k.editTable);k["class"]="my-edit edit-"+k.sName}});if(self.options.bEditTable){self.tableOptions["fnDrawCallback"]=function(){for(var key in self.options.oEditTable){$(self.options.sTable+" tbody tr td.edit-"+key).each(function(){var data=self.table.row($(this).closest('tr')).data(),mv={};if(data){mv['value']=data[key];mv['pk']=data[self.options.sEditPk]}$(this).editable($.extend(self.options.oEditTable[key],mv))})}}}if(self.options.oEditFormParams.bMultiCols&&empty(self.options.oEditFormParams.modalClass)){self.options.oEditFormParams.modalClass="bs-example-modal-lg";self.options.oEditFormParams.modalDialogClass="modal-lg"}if(self.options.oEditFormParams.bMultiCols&&self.options.oEditFormParams.index%self.options.oEditFormParams.iCols!=(self.options.oEditFormParams.iCols-1)){form+='</div>'}var Modal=createModal({"params":{"id":"myModal"},"html":form,"bClass":"me-table-save","modalClass":self.options.oEditFormParams.modalClass,"modalDialogClass":self.options.oEditFormParams.modalDialogClass},{"params":{"id":"data-info"},"html":views});if(this.bHandleDetails){form='<form id="myDetailForm" class="form-horizontal" action="'+this.oDetails.sBaseUrl+'" name="myDetailForm" method="post" enctype="multipart/form-data"><fieldset>';views='<table class="table table-bordered table-striped table-detail">';this.oDetails.oTableOptions.aoColumns.forEach(function(k){views+=createViewTr(k.title,'detail-'+k.data);if(k.edit!=undefined)form+=createForm(k)});Modal+=createModal({"params":{"id":"myDetailModal"},"html":form,"bClass":"me-table-save"},{"params":{"id":"data-info-detail"},"html":views})}if(aOrders.length>0){this.tableOptions.order=aOrders}if(aTargets.length>0){if(this.tableOptions.columnDefs){this.tableOptions.columnDefs.push({"targets":aTargets,"visible":false})}else{this.tableOptions.columnDefs=[{"targets":aTargets,"visible":false}]}}$("body").append(Modal)};MeTable.prototype.init=function(){var self=this;this.CreateForm();this.table=$(this.options.sTable).DataTable(this.tableOptions);if(this.options.bRenderH1)$('h1').html(this.options.sTitle);if(this.options.sSearchType=='middle'){$('#showTable_filter').html('<form action="post" id="searchForm">'+self.options.sSearchHtml+'</form>');$('.me-search').on('keyup change',function(){self.table.draw()});$('#showTable_wrapper div.row div.col-xs-6:first').removeClass('col-xs-6').addClass('col-xs-2').next().removeClass('col-xs-6').addClass('col-xs-10')}else{$(this.options.sSearchForm).append(self.options.sSearchHtml)}$('.me-table-insert').click(function(evt){evt.preventDefault();self.insert()});$(document).on('click','.me-table-edit',function(evt){evt.preventDefault();self.update($(this).attr('table-data'))});$(document).on('click','.me-table-del',function(evt){evt.preventDefault();self.delete($(this).attr('table-data'))});$(document).on('click','.me-table-view',function(evt){evt.preventDefault();self.view($(this).attr('table-data'))});$('.me-table-delete').click(function(evt){evt.preventDefault();self.deleteAll()});$('.me-table-save').click(function(evt){evt.preventDefault();self.save()});$('.me-table-reload').click(function(evt){evt.preventDefault();self.search()});$('.me-table-export').click(function(evt){evt.preventDefault();self.export()});$(document).on('click',self.options.sTable+' th input:checkbox',function(){var that=this;$(this).closest('table').find('tr > td:first-child input:checkbox').each(function(){this.checked=that.checked;$(this).closest('tr').toggleClass('selected')})});if(self.bHandleDetails){if(this.bHandleDetails)this.details=$(this.oDetails.sTable).DataTable(this.oDetails.oTableOptions);$('.me-table-insert-detail').click(function(evt){evt.preventDefault();self.insert(true)});$(document).on('click','.me-table-view-detail',function(evt){evt.preventDefault();self.view($(this).attr('table-data'),true)});$(document).on('click','.me-table-edit-detail',function(evt){evt.preventDefault();self.update($(this).attr('table-data'),true)});$(document).on('click','.me-table-del-detail',function(evt){evt.preventDefault();self.delete($(this).attr('table-data'),true)});$(self.options.sTable+' tbody').on('click',self.oDetails.sClickSelect,function(){var tr=$(this).closest('tr'),row=self.table.row(tr);tr.siblings(tr).each(function(){if(self.table.row($(this)).child.isShown())self.table.row($(this)).child.hide();$(this).removeClass('shown')});if(row.child.isShown()){row.child.hide();tr.removeClass('shown')}else{self.oDetailParams=row.data();self.oDetailObject=row;self.details.draw();tr.addClass('shown')}})}if(self.options.bEditTable){$.fn.editable.defaults.mode='inline';$.fn.editableform.loading="<div class='editableform-loading'><i class='ace-icon fa fa-spinner fa-spin fa-2x light-blue'></i></div>";$.fn.editableform.buttons='<button type="submit" class="btn btn-info editable-submit"><i class="ace-icon fa fa-check"></i></button>'+'<button type="button" class="btn editable-cancel"><i class="ace-icon fa fa-times"></i></button>';$.fn.editable.defaults.ajaxOptions={type:"POST",dataType:'json'}}if(self.options.bColResize)$(self.options.sTable).colResizable();if(empty(self.options.aFileSelector)&&self.options.aFileSelector.length>0){for(var i in self.options.aFileSelector){aceFileUpload(self.options.aFileSelector[i],self.options.sBaseUrl+self.options.aActionUrl.upload)}}};MeTable.prototype.search=function(){this.table.draw()};MeTable.prototype.initForm=function(data,isDetail){this.bDetail=isDetail;if(typeof this.beforeShow=='function'&&!this.beforeShow(data,isDetail))return false;layer.close(this.options.iViewLoading);var f=this.options.sFormId,m=this.options.sModal;if(isDetail){f=this.oDetails.sFormId;m=this.oDetails.sModal}else{$(m).find('h4').html(this.options.sTitle+(this.actionType=="insert"?"新增":"编辑"))}InitForm(f,data);if(typeof this.afterShow=='function'&&!this.afterShow(data,isDetail))return false;$(m).modal({backdrop:"static"})};MeTable.prototype.view=function(row,isDetail){if(this.options.iViewLoading!=0)return false;var self=this,data=this.table.data()[row],obj=this.tableOptions.aoColumns,t=self.options.sTitle,c='.data-info-',i="#data-info";if(isDetail){data=this.details.data()[row];obj=this.oDetails.oTableOptions.aoColumns;t='';c+='detail-';i="#data-info-detail"}if(data!=undefined){viewTable(obj,data,c,row);this.options.iViewLoading=layer.open({type:this.options.oViewLayerConfig.type,shade:this.options.oViewLayerConfig.shade,shadeClose:this.options.oViewLayerConfig.shadeClose,title:t+'详情',content:$(i),area:this.options.oViewLayerConfig.area,cancel:function(index){layer.close(index)},end:function(){$('.views-info').html('');self.options.iViewLoading=0},maxmin:this.options.oViewLayerConfig.maxmin});if(this.options.bViewFull)layer.full(this.options.iViewLoading)}};MeTable.prototype.insert=function(isDetail){this.actionType="insert";this.initForm(undefined,isDetail)};MeTable.prototype.update=function(row,isDetail){this.actionType="update";this.initForm(isDetail?this.details.data()[row]:this.table.data()[row],isDetail)};MeTable.prototype.delete=function(row,isDetail){var self=this;this.actionType="delete";layer.confirm('您确定需要删除这条数据吗?',{title:'确认操作',btn:['确定','取消'],shift:4,icon:0},function(){self.save(isDetail?self.details.data()[row]:self.table.data()[row])},function(){layer.msg('您取消了删除操作！',{time:800})})};MeTable.prototype.deleteAll=function(){var data=[],self=this;this.actionType="deleteAll";$(this.options.sTable+" tbody input:checkbox:checked").each(function(){data.push($(this).val())});if(data.length<1){layer.msg('您没有选择需要删除的数据 !',{icon:5});return false}layer.confirm('您确定需要删除这'+data.length+'条数据吗?',{title:'确认操作',btn:['确定','取消'],shift:4,icon:0},function(){self.save({"ids":data.join(',')})},function(){layer.msg('您取消了删除操作！',{time:800})})};MeTable.prototype.save=function(data){if(in_array(this.actionType,["insert","update","delete","deleteAll"])){var self=this,sFormId=this.options.sFormId,sBaseUrl=self.options.sBaseUrl+self.options.aActionUrl[self.actionType],sModal=self.options.sModal;if(this.bDetail){sFormId=self.oDetails.sFormId;sBaseUrl=self.oDetails.sBaseUrl+self.oDetails.aActionUrl[self.actionType];sModal=self.oDetails.sModal}if(in_array(this.actionType,["insert","update"])){if($(sFormId).validate({errorElement:'div',errorClass:'help-block',focusInvalid:false,highlight:function(e){$(e).closest('.form-group').removeClass('has-info').addClass('has-error')},success:function(e){$(e).closest('.form-group').removeClass('has-error');$(e).remove()}}).form()){data=$(sFormId).serializeArray()}else{return false}}if(data){if(typeof self.beforeSave!='function'||self.beforeSave(data)){self.options.iLoading=layer.load();$.ajax({url:sBaseUrl,type:'POST',data:data,dataType:'json'}).always(function(){layer.close(self.options.iLoading)}).done(function(json){layer.msg(json.errMsg,{icon:json.errCode==0?6:5});if(json.errCode==0){if(typeof self.afterSave!='function'||self.afterSave(json.data)){self.table.draw(false);if(self.actionType!=="delete")$(sModal).modal('hide');self.actionType=""}}}).fail(ajaxFail);return false}}}layer.msg('操作有误');return false};MeTable.prototype.export=function(bAll){var self=this,html='<form action="'+self.options.sBaseUrl+self.options.aActionUrl.export+'" target="_blank" method="POST" class="me-export" style="display:none">';html+='<input type="hidden" name="iSize" value="'+(bAll?0:$('select[name='+self.options.sTable.replace('#','')+'_length]').val())+'"/>';html+='<input type="hidden" name="sTitle" value="'+self.options.sTitle+'"/>';html+='<input type="hidden" name="_csrf" value="'+$('meta[name=csrf-token]').attr('content')+'"/>';this.tableOptions.aoColumns.forEach(function(k,v){if(k.data!=null&&(k.isExport==undefined))html+='<input type="hidden" name="aFields['+k.data+']" value="'+k.title+'"/>'});var value=$(self.options.sSearchForm).serializeArray();for(var i in value){if(empty(value[i]["value"])||value[i]["value"]=="All")continue;html+='<input type="hidden" name="params['+value[i]['name']+']" value="'+value[i]["value"]+'"/>'}var $form=$(html);$('body').append($form);var deferred=new $.Deferred,temporary_iframe_id='temporary-iframe-'+(new Date()).getTime()+'-'+(parseInt(Math.random()*1000)),temp_iframe=$('<iframe id="'+temporary_iframe_id+'" name="'+temporary_iframe_id+'" 								frameborder="0" width="0" height="0" src="about:blank"								style="position:absolute; z-index:-1; visibility: hidden;"></iframe>').insertAfter($form);$form.append('<input type="hidden" name="temporary-iframe-id" value="'+temporary_iframe_id+'" />');temp_iframe.data('deferrer',deferred);$form.attr({method:'POST',enctype:'multipart/form-data',target:temporary_iframe_id});$form.get(0).submit();var ie_timeout=setTimeout(function(){ie_timeout=null;deferred.reject($(document.getElementById(temporary_iframe_id).contentDocument).text());$('.me-export').remove()},500);deferred.fail(function(result){if(result){try{result=$.parseJSON(result);layer.msg(result.errMsg,{icon:result.errCode==0?6:5})}catch(e){layer.msg("服务器没有响应...")}}else{layer.msg('数据正在导出, 请稍候...',{icon:6})}}).always(function(){clearTimeout(ie_timeout)});deferred.promise()};return MeTable})();